@page "/teams/edit/{Id:guid}"
@layout EmptyLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using RewardsAndRecognitionBlazorApp.ViewModels
@inject HttpClient Http
@inject NavigationManager Nav
@inject JsonSerializerOptions JsonOptions

<h2 class="mb-3">
    <i class="bi bi-pencil-square me-2"></i> Edit Team
</h2>

@if (!string.IsNullOrWhiteSpace(Error))
{
    <div class="alert alert-danger">@Error</div>
}

@if (IsLoading)
{
    <div class="alert alert-info">Loading team...</div>
}
else if (Team is null)
{
    <div class="alert alert-warning">
        Team not found.
        <button class="btn btn-link p-0 ms-2" @onclick="BackToList">Back</button>
    </div>
}
else
{
    <EditForm Model="Team" OnValidSubmit="UpdateAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="card shadow-sm">
            <div class="card-body">

                <div class="mb-3">
                    <label class="form-label">Team Name</label>
                    <InputText class="form-control" @bind-Value="Team.Name" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Team Lead</label>
                    <InputSelect class="form-select" @bind-Value="Team.TeamLeadId">
                        <option value="">-- Select Team Lead --</option>
                        @foreach (var u in Leads)
                        {
                            <option value="@u.Id">@u.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label">Manager</label>
                    <InputSelect class="form-select" @bind-Value="Team.ManagerId">
                        <option value="">-- Select Manager --</option>
                        @foreach (var u in Managers)
                        {
                            <option value="@u.Id">@u.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label">Director</label>
                    <InputSelect class="form-select" @bind-Value="Team.DirectorId">
                        <option value="">-- Select Director --</option>
                        @foreach (var u in Directors)
                        {
                            <option value="@u.Id">@u.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button type="button"
                            class="btn btn-secondary"
                            disabled="@IsBusy"
                            @onclick="BackToList">
                        Cancel
                    </button>

                    <button type="submit"
                            class="btn btn-primary"
                            disabled="@IsBusy">
                        <i class="bi bi-check-circle me-1"></i>
                        @(IsBusy ? "Saving..." : "Save")
                    </button>
                </div>

            </div>
        </div>
    </EditForm>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private TeamView Team { get; set; }

    private bool IsBusy { get; set; }
    private bool IsLoading { get; set; } = true;
    private string? Error { get; set; }

    private List<UserOption> Leads { get; set; } = new();
    private List<UserOption> Managers { get; set; } = new();
    private List<UserOption> Directors { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadAllAsync();
    }

    private async Task LoadAllAsync()
    {
        try
        {
            IsLoading = true;
            Error = null;

            // Load dropdowns first
            await LoadDropdownsAsync();

            // Load team
            Team = await Http.GetFromJsonAsync<TeamView>($"api/Team/{Id}", JsonOptions);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
            Team = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadDropdownsAsync()
    {
        // Uses your real endpoints
        var leads = await Http.GetFromJsonAsync<List<UserDto>>("api/user/leads", JsonOptions) ?? new();
        var managers = await Http.GetFromJsonAsync<List<UserDto>>("api/user/managers", JsonOptions) ?? new();
        var directors = await Http.GetFromJsonAsync<List<UserDto>>("api/user/directors", JsonOptions) ?? new();

        // Convert to dropdown options (Name only)
        Leads = ToOptions(leads);
        Managers = ToOptions(managers);
        Directors = ToOptions(directors);
    }

    private static List<UserOption> ToOptions(IEnumerable<UserDto> users)
    {
        return users
            .Where(u => !string.IsNullOrWhiteSpace(u.Id))
            .Where(u => u.IsDeleted == false) // hide deleted users
            .Select(u => new UserOption
            {
                Id = u.Id!.Trim(),
                Name = string.IsNullOrWhiteSpace(u.Name) ? "Unknown" : u.Name.Trim()
            })
            .OrderBy(u => u.Name)
            .ToList();
    }

    private async Task UpdateAsync()
    {
        if (Team is null) return;

        // Minimal validation before hitting API (your API will also validate)
        if (string.IsNullOrWhiteSpace(Team.Name))
        {
            Error = "Team Name is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Team.TeamLeadId) ||
            string.IsNullOrWhiteSpace(Team.ManagerId) ||
            string.IsNullOrWhiteSpace(Team.DirectorId))
        {
            Error = "Please select Team Lead, Manager, and Director.";
            return;
        }

        try
        {
            IsBusy = true;
            Error = null;

            // Matches your controller: PUT api/team/{id}
            var response = await Http.PutAsJsonAsync($"api/Team/{Id}", Team);

            if (!response.IsSuccessStatusCode)
            {
                var message = await response.Content.ReadAsStringAsync();
                Error = string.IsNullOrWhiteSpace(message)
                    ? $"Update failed ({(int)response.StatusCode})"
                    : message;
                return;
            }

            Nav.NavigateTo("/teams");
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void BackToList()
    {
        Nav.NavigateTo("/teams");
    }

    private sealed class UserOption
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
    }

    // DTO shape expected from api/user/leads, managers, directors
    // If those endpoints return full User entity, this still works.
    private sealed class UserDto
    {
        public string? Id { get; set; }
        public string? Name { get; set; }
        public bool IsDeleted { get; set; }
    }
}
