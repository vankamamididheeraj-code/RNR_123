@page "/nominations"
@page "/nomination/index"
@layout EmptyLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Manager,Director,TeamLead")]
@using System.Net.Http.Json
@inject RewardsAndRecognitionBlazorApp.ViewModels.UserSession Session
@using Microsoft.AspNetCore.Components.Authorization
@using RewardsAndRecognitionBlazorApp.ViewModels

@inject HttpClient Http
@inject NavigationManager Nav
@* @inject AuthenticationStateProvider AuthStateProvider *@
@inject IJSRuntime JS
@inject JsonSerializerOptions JsonOptions

<RoleBasedNavBar />

<style>
    /* ===== Page Loading Spinner (full screen overlay) ===== */
    .page-loading-spinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* ===== Theme variables ===== */
    :root {
        --indigo-main: #3f51b5;
        --indigo-light: #5c6bc0;
        --indigo-dark: #303f9f;
        --danger: #c62828;
        --danger-hover: #b71c1c;
        --text-light: #fff;
    }

    /* ===== Buttons ===== */
    .btn {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
    }

    .btn-indigo {
        background: linear-gradient(to right, var(--indigo-main), var(--indigo-light));
        color: var(--text-light);
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

        .btn-indigo:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
            color: var(--text-light);
        }

    .btn-danger {
        background: var(--danger);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-danger:hover {
            background: var(--danger-hover);
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

    .btn-disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
    }

    /* Optional utility used in your MVC UI */
    .no-click {
        pointer-events: none;
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* ===== Table ===== */
    .table-custom {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

        .table-custom th,
        .table-custom td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
        }

        .table-custom thead th {
            background: linear-gradient(to right, var(--indigo-main), var(--indigo-light));
            color: white;
            border-bottom: none;
        }

    /* Muted deleted rows (you already apply text-muted in markup) */
    .text-muted {
        opacity: 0.65;
    }

    /* ===== Filter Bar ===== */
    .filter-bar {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            min-width: 200px;
        }

    /* ===== Popup Overlay + Preview Card ===== */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        display: none; /* your Blazor inline style sets display:flex when open */
        justify-content: center;
        align-items: center;
        z-index: 9999;
        padding: 14px;
    }

    .popup-review-card {
        background: white;
        border-radius: 12px;
        max-width: 1100px;
        width: 100%;
        color: #333;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        max-height: 85vh;
        overflow: hidden;
    }

    .popup-sticky-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 100;
        padding: 16px;
        border-bottom: 1px solid #eee;
    }

    .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .popup-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        font-weight: bold;
        width: 32px;
        height: 32px;
        margin: 8px;
        padding-bottom: 8px;
        padding-right: 8px;
        color: #999;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .popup-close:hover {
            background-color: red;
            color: white;
            border-radius: 50%;
        }

    /* Scrollable body */
    .popup-scroll-body {
        overflow-y: auto;
        padding: 20px;
    }

    /* Fields inside popup */
    .popup-fields {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 10px;
    }

    .popup-field {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 6px;
    }

    .popup-label {
        font-weight: 600;
        color: var(--indigo-dark);
        margin-bottom: 5px;
        display: block;
    }

    .popup-block {
        background-color: #f3f5fa;
        border: 1px solid #ddd;
        padding: 12px 16px;
        border-radius: 6px;
        font-size: 15px;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: #333;
    }

    /* Headings */
    .text-indigo {
        color: var(--indigo-main);
    }

    /* ===== Page Header ===== */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 30px 0 20px;
        gap: 12px;
        flex-wrap: wrap;
    }

    .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-primary {
        background-color: var(--indigo-main);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        border: none;
    }

    .btn-primary:hover {
        background-color: var(--indigo-dark);
        color: white;
        transform: translateY(-1px);
    }

</style>

@if (isLoading)
{
    <div class="page-loading-spinner">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}

<div class="page-header">
    <div>
        <h2><i class="bi bi-star-fill me-2"></i> Nominations</h2>
    </div>

    <div class="actions">
        <a class="btn btn-primary" href="/nomination/create">
            <i class="bi bi-plus-circle-fill"></i> Create Nomination
        </a>

        <a class="btn btn-indigo" href="/nomination/upload" style="white-space: nowrap;">
            <i class="bi bi-file-earmark-arrow-up-fill"></i> Import from Excel
        </a>
    </div>
</div>

@* <div class="filter-bar">
    <select class="form-select" style="min-width:200px"
            @bind="selectedFilter"
            @bind:after="OnFilterChanged">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
        <option value="deleted">Deleted</option>
    </select>

    <input class="form-control" style="min-width:240px"
           placeholder="Search nominee / nominator / category..."
           @bind="liveSearch"
           @bind:event="oninput" />
</div> *@

<table class="table-custom">
    <thead>
        <tr>
            <th>Nominee</th>
            <th>Nominator</th>
            <th>Category</th>
            <th>Quarter</th>
            <th>Status</th>
            <th>Created</th>
            <th style="width:240px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (!FilteredItems.Any())
        {
            <tr>
                <td colspan="7">No nominations found.</td>
            </tr>
        }
        else
        {
            @foreach (var n in FilteredItems)
            {
                <tr class="@((n.IsDeleted) ? "text-muted" : "")">
                    <td>@(n.Nominee?.Email ?? n.NomineeId)</td>
                    <td>@(n.Nominator?.Email ?? n.NominatorId)</td>
                    <td>@(n.Category?.Name ?? n.CategoryId.ToString())</td>
                    @* <td>@(n.YearQuarter?.Name ?? n.YearQuarterId.ToString())</td> *@
                    <td>@GetYearQuarterText(n)</td>
                    <td>@n.Status</td>
                    <td>@n.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        <button class="btn btn-indigo" @onclick="() => OpenPreview(n)">
                            <i class="bi bi-eye"></i> Preview
                        </button>

                        @if (!n.IsDeleted && CanReview(n))
                        {
                            <button class="btn btn-success" @onclick="() => NavigateToReview(n.Id)">
                                <i class="bi bi-pencil-square"></i> Review
                            </button>
                        }

                        @if (!n.IsDeleted)
                        {
                            @if (CanDelete(n))
                            {
                                <button class="btn btn-danger" @onclick="() => ConfirmDelete(n.Id)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-disabled" disabled title="You don't have permission to delete this nomination">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            }
                        }
                        else
                        {
                            <button class="btn btn-disabled" disabled title="This nomination has been deleted">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        }
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<div class="mt-3 d-flex justify-content-end">
    <Pager PageNumber="pageNumber" PageSize="pageSize" TotalCount="totalCount" PageChanged="OnPageChanged" />
</div>

@if (showPreview && preview != null)
{
    <div class="popup-overlay" style="display:flex;" @onclick="ClosePreview">
        <div class="popup-review-card" @onclick:stopPropagation="true">
            <div class="popup-sticky-header">
                <div class="popup-header">
                    <h4 class="m-0 text-indigo">Nomination Preview</h4>
                    <button class="popup-close" @onclick="ClosePreview">×</button>
                </div>
            </div>

            <div class="popup-scroll-body">
                <div class="popup-fields">
                    <div class="popup-field">
                        <span class="popup-label">Nominee Email</span>
                        <div class="popup-block">@preview.NomineeEmail</div>
                    </div>

                    <div class="popup-field">
                        <span class="popup-label">Category</span>
                        <div class="popup-block">@preview.CategoryName</div>
                    </div>

                    <div class="popup-field">
                        <span class="popup-label">Year / Quarter</span>
                        <div class="popup-block">@preview.YearQuarterName</div>
                    </div>

                    <div class="popup-field">
                        <span class="popup-label">Description</span>
                        <div class="popup-block">@SanitizeHtml(preview.Description)</div>
                    </div>

                    <div class="popup-field">
                        <span class="popup-label">Achievements</span>
                        <div class="popup-block">@SanitizeHtml(preview.Achievements)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool IS_MANAGER;
    private bool IS_DIRECTOR;
    private bool IS_TEAMLEAD;

    private bool isLoading = true;

    private List<NominationView> all = new();
    private string selectedFilter = "all";
    private string liveSearch = "";

    // paging
    private int pageNumber = 1;
    private int pageSize = 5;
    private long totalCount = 0;

    private bool showPreview;
    private NominationPreview? preview;
    private bool isTeamLeadView = false;

    protected override async Task OnInitializedAsync()
    {
        //await LoadRoles();
        // Initialize session from localStorage before loading data
        await Session.InitializeAsync(JS);
        
        // Read query parameters
        var uri = new Uri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var filterParam = query["filter"];
        
        // If TeamLead navigating from dashboard, use GetByNominator endpoint
        if (!string.IsNullOrEmpty(filterParam) && Session.Role?.Equals("TeamLead", StringComparison.OrdinalIgnoreCase) == true)
        {
            if (filterParam == "all")
            {
                isTeamLeadView = true;
                await LoadTeamLeadNominations();
            }
            else if (filterParam == "pending")
            {
                isTeamLeadView = true;
                await LoadTeamLeadNominationsPending();
            }
            else if (filterParam == "directorapproved" || filterParam == "directorrejected")
            {
                isTeamLeadView = true;
                await LoadTeamLeadNominationsFiltered(filterParam);
            }
            else
            {
                await LoadData(includeDeleted: false);
            }
        }
        // If Manager navigating from dashboard
        else if (!string.IsNullOrEmpty(filterParam) && Session.Role?.Equals("Manager", StringComparison.OrdinalIgnoreCase) == true)
        {
            if (filterParam == "all")
            {
                await LoadManagerNominations();
            }
            else if (filterParam == "pendingmanager")
            {
                await LoadManagerNominationsPending();
            }
            else if (filterParam == "managerapproved")
            {
                await LoadManagerNominationsApproved();
            }
            else if (filterParam == "managerrejected")
            {
                await LoadManagerNominationsRejected();
            }
            else
            {
                await LoadData(includeDeleted: false);
            }
        }
        // If Director navigating from dashboard
        else if (!string.IsNullOrEmpty(filterParam) && Session.Role?.Equals("Director", StringComparison.OrdinalIgnoreCase) == true)
        {
            if (filterParam == "all")
            {
                await LoadDirectorNominations();
            }
            else if (filterParam == "pending")
            {
                await LoadDirectorNominationsPending();
            }
            else if (filterParam == "directorapproved")
            {
                await LoadDirectorNominationsApproved();
            }
            else if (filterParam == "directorrejected")
            {
                await LoadDirectorNominationsRejected();
            }
            else
            {
                await LoadData(includeDeleted: false);
            }
        }
        else
        {
            // If no filter param, load based on role
            if (Session.Role?.Equals("TeamLead", StringComparison.OrdinalIgnoreCase) == true)
            {
                isTeamLeadView = true;
                await LoadTeamLeadNominations();
            }
            else if (Session.Role?.Equals("Manager", StringComparison.OrdinalIgnoreCase) == true)
            {
                await LoadManagerNominations();
            }
            else if (Session.Role?.Equals("Director", StringComparison.OrdinalIgnoreCase) == true)
            {
                await LoadDirectorNominations();
            }
            else
            {
                await LoadData(includeDeleted: false);
            }
        }
        
        isLoading = false;
    }

    // private async Task LoadRoles()
    // {
    //     var role = Session.Role ?? string.Empty;

    //     IS_MANAGER = role.Equals("Manager", StringComparison.OrdinalIgnoreCase);
    //     IS_DIRECTOR = role.Equals("Director", StringComparison.OrdinalIgnoreCase);
    //     IS_TEAMLEAD = role.Equals("TeamLead", StringComparison.OrdinalIgnoreCase);
    // }

    private async Task LoadTeamLeadNominations()
    {
        try
        {
            // Use fetchWithCredentials to call GetByNominator endpoint
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                $"api/nomination/nominator/{Session.UserId}",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            all = JsonSerializer.Deserialize<List<NominationView>>(response, JsonOptions) ?? new List<NominationView>();
            
            // Filter out deleted nominations
            all = all.Where(n => !n.IsDeleted).ToList();
            
            totalCount = all.Count;
            
            // For TeamLead view, we don't use pagination
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading TeamLead nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadTeamLeadNominationsPending()
    {
        try
        {
            // Use fetchWithCredentials to call GetByNominator endpoint
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                $"api/nomination/nominator/{Session.UserId}",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var allNominations = JsonSerializer.Deserialize<List<NominationView>>(response, JsonOptions) ?? new List<NominationView>();
            
            // Filter for nominations that are not DirectorApproved or DirectorRejected and not deleted
            all = allNominations.Where(n => 
                n.Status != NominationStatus.DirectorApproved && 
                n.Status != NominationStatus.DirectorRejected &&
                !n.IsDeleted
            ).ToList();
            
            totalCount = all.Count;
            
            // For TeamLead view, we don't use pagination
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading TeamLead pending nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadTeamLeadNominationsFiltered(string status)
    {
        try
        {
            // Use fetchWithCredentials to call GetByNominator endpoint
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                $"api/nomination/nominator/{Session.UserId}",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var allNominations = JsonSerializer.Deserialize<List<NominationView>>(response, JsonOptions) ?? new List<NominationView>();
            
            // Filter by status and exclude deleted
            var statusEnum = status.ToLower() == "directorapproved" ? NominationStatus.DirectorApproved : NominationStatus.DirectorRejected;
            all = allNominations.Where(n => n.Status == statusEnum && !n.IsDeleted).ToList();
            
            totalCount = all.Count;
            
            // For TeamLead view, we don't use pagination
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading TeamLead filtered nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadManagerNominations()
    {
        try
        {
            // Get all nominations via paged endpoint (Manager can see all nominations under their teams)
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            all = paged?.Items?.ToList() ?? new List<NominationView>();
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Manager nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadManagerNominationsPending()
    {
        try
        {
            // Get all nominations and filter for PendingManager status
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            var allNominations = paged?.Items?.ToList() ?? new List<NominationView>();
            all = allNominations.Where(n => n.Status == NominationStatus.PendingManager).ToList();
            
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Manager pending nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadManagerNominationsApproved()
    {
        try
        {
            // Get all nominations and filter where this manager approved at Manager level
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            var allNominations = paged?.Items?.ToList() ?? new List<NominationView>();
            all = allNominations.Where(n => 
                n.Approvals != null && 
                n.Approvals.Any(a => 
                    a.ApproverId == Session.UserId && 
                    a.Level == ApprovalLevel.Manager && 
                    a.Action == ApprovalAction.Approved
                )
            ).ToList();
            
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Manager approved nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadManagerNominationsRejected()
    {
        try
        {
            // Get all nominations and filter where this manager rejected at Manager level
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            var allNominations = paged?.Items?.ToList() ?? new List<NominationView>();
            all = allNominations.Where(n => 
                n.Approvals != null && 
                n.Approvals.Any(a => 
                    a.ApproverId == Session.UserId && 
                    a.Level == ApprovalLevel.Manager && 
                    a.Action == ApprovalAction.Rejected
                )
            ).ToList();
            
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Manager rejected nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadDirectorNominations()
    {
        try
        {
            // Get all nominations (Director can see all nominations under their teams)
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            all = paged?.Items?.ToList() ?? new List<NominationView>();
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Director nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadDirectorNominationsPending()
    {
        try
        {
            // Get all nominations where Director has not taken action yet
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            var allNominations = paged?.Items?.ToList() ?? new List<NominationView>();
            
            // Filter for nominations pending director review (matching dashboard logic)
            all = allNominations.Where(n => 
                n.Status == NominationStatus.ManagerApproved || 
                n.Status == NominationStatus.ManagerRejected ||
                n.Status == NominationStatus.PendingDirector
            ).ToList();
            
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Director pending nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadDirectorNominationsApproved()
    {
        try
        {
            // Get all nominations where director approved (matching dashboard logic)
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            var allNominations = paged?.Items?.ToList() ?? new List<NominationView>();
            all = allNominations.Where(n => 
                n.Status == NominationStatus.DirectorApproved
            ).ToList();
            
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = 5;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Director approved nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadDirectorNominationsRejected()
    {
        try
        {
            // Get all nominations where director rejected (matching dashboard logic)
            var result = await JS.InvokeAsync<JsonElement>(
                "fetchWithCredentials",
                "GET",
                "api/nomination/paged?pageNumber=1&pageSize=1000&includeDeleted=false",
                null
            );

            string response = result.GetProperty("text").GetString() ?? "[]";
            var paged = JsonSerializer.Deserialize<PagedResult<NominationView>>(response, JsonOptions);
            
            var allNominations = paged?.Items?.ToList() ?? new List<NominationView>();
            all = allNominations.Where(n => 
                n.Status == NominationStatus.DirectorRejected
            ).ToList();
            
            totalCount = all.Count;
            pageNumber = 1;
            pageSize = totalCount > 0 ? (int)totalCount : 10;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading Director rejected nominations:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private async Task LoadData(bool includeDeleted)
    {
        try
        {
            var status = selectedFilter == "all" ? null : selectedFilter;
            var q = string.IsNullOrWhiteSpace(liveSearch) ? null : liveSearch;
            var url = $"api/nomination/paged?pageNumber={pageNumber}&pageSize={pageSize}&includeDeleted={includeDeleted.ToString().ToLower()}";
            if (!string.IsNullOrWhiteSpace(status)) url += $"&status={System.Net.WebUtility.UrlEncode(status)}";
            if (!string.IsNullOrWhiteSpace(q)) url += $"&q={System.Net.WebUtility.UrlEncode(q)}";

            var paged = await Http.GetFromJsonAsync<RewardsAndRecognitionBlazorApp.ViewModels.PagedResult<NominationView>>(url, JsonOptions);
            if (paged != null)
            {
                all = paged.Items?.ToList() ?? new List<NominationView>();
                pageNumber = paged.PageNumber;
                pageSize = paged.PageSize;
                totalCount = paged.TotalCount;
            }
            else
            {
                all = new List<NominationView>();
                totalCount = 0;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading nominations paged:", ex.ToString());
            all = new List<NominationView>();
            totalCount = 0;
        }
    }

    private string GetYearQuarterText(NominationView n)
    {
        return n.YearQuarter != null
            ? $"{n.YearQuarter.Year} Q{n.YearQuarter.Quarter}"
            : n.YearQuarterId.ToString();
    }

    private async void OnFilterChanged()
    {
        pageNumber = 1;
        await LoadData(includeDeleted: selectedFilter == "deleted");
        StateHasChanged();
    }

    private async Task OnPageChanged(int newPage)
    {
        pageNumber = newPage;
        
        // For role-based views, just update the page number and refresh the view
        // FilteredItems will handle client-side pagination
        StateHasChanged();
    }


    private IEnumerable<NominationView> FilteredItems
    {
        get
        {
            IEnumerable<NominationView> items = all;

            items = selectedFilter switch
            {
                "deleted" => items.Where(x => x.IsDeleted),
                "pending" => items.Where(x => !x.IsDeleted && x.Status.ToString().StartsWith("Pending")),
                "approved" => items.Where(x => !x.IsDeleted && x.Status.ToString().Contains("Approved")),
                "rejected" => items.Where(x => !x.IsDeleted && x.Status.ToString().Contains("Rejected")),
                _ => items
            };

            // Apply ordering
            var orderedItems = items.OrderByDescending(x => x.CreatedAt);
            
            // Apply client-side pagination for role-based views that load all data at once
            var skip = (pageNumber - 1) * pageSize;
            return orderedItems.Skip(skip).Take(pageSize);
        }
    }

    private void OpenPreview(NominationView n)
    {
        preview = new NominationPreview
        {
            NomineeEmail = n.Nominee?.Email ?? n.NomineeId,
            CategoryName = n.Category?.Name ?? n.CategoryId.ToString(),
            //YearQuarterName = n.YearQuarter?.Name ?? n.YearQuarterId.ToString(),
            YearQuarterName = @GetYearQuarterText(n),
            Description = n.Description,
            Achievements = n.Achievements
        };

        showPreview = true;
    }

    private void ClosePreview()
    {
        showPreview = false;
        preview = null;
    }

    private bool CanDelete(NominationView n)
    {
        // Check if user has a valid role for deleting
        var role = Session?.Role ?? "";

        // Only Manager, Director, and TeamLead can delete
        var canDelete = role.Equals("Manager", StringComparison.OrdinalIgnoreCase)
            || role.Equals("Director", StringComparison.OrdinalIgnoreCase)
            || role.Equals("Admin", StringComparison.OrdinalIgnoreCase)
            || role.Equals("TeamLead", StringComparison.OrdinalIgnoreCase);

        return canDelete;
    }

    private bool CanReview(NominationView n)
    {
        var role = Session?.Role ?? "";
        var status = n.Status.ToString();

        // TeamLead cannot approve/reject - they can only create, preview, and delete nominations
        
        // Manager can review nominations pending manager approval
        if (role.Equals("Manager", StringComparison.OrdinalIgnoreCase))
        {
            return status.Equals("PendingManager", StringComparison.OrdinalIgnoreCase);
        }

        // Director can review nominations reviewed by Manager (both approved and rejected) for final decision
        if (role.Equals("Director", StringComparison.OrdinalIgnoreCase))
        {
            return status.Equals("ManagerApproved", StringComparison.OrdinalIgnoreCase) 
                || status.Equals("ManagerRejected", StringComparison.OrdinalIgnoreCase)
                || status.Equals("PendingDirector", StringComparison.OrdinalIgnoreCase);
        }

        return false;
    }

    private void NavigateToReview(Guid id)
    {
        Nav.NavigateTo($"/nomination/review/{id}");
    }

    private async Task ConfirmDelete(Guid id)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", "Are you sure? This action cannot be undone.");
        if (!ok) return;

        try
        {
            var jsResp = await JS.InvokeAsync<JsonElement>("fetchWithCredentials", "DELETE", $"api/nomination/{id}");
            
            var jsOk = jsResp.GetProperty("ok").GetBoolean();
            if (jsOk)
            {
                var item = all.FirstOrDefault(x => x.Id == id);
                if (item != null)
                {
                    item.IsDeleted = true;
                    StateHasChanged();
                }
                await JS.InvokeVoidAsync("alert", "Nomination deleted successfully.");
            }
            else
            {
                var text = jsResp.GetProperty("text").GetString() ?? "Unknown error";
                await JS.InvokeVoidAsync("alert", $"Delete failed: {text}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"An error occurred: {ex.Message}");
        }
    }

    private void NavigateToDelete(Guid id)
    {
        Nav.NavigateTo($"/nominations/delete/{id}");
    }

    private MarkupString SanitizeHtml(string? html)
    {
        if (string.IsNullOrWhiteSpace(html))
            return new MarkupString("");

        // Simple HTML sanitization - allow only safe formatting tags
        // Remove potentially dangerous tags and attributes
        var sanitized = html;
        
        // Remove script tags and their content
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, 
            @"<script[^>]*>.*?</script>", "", 
            System.Text.RegularExpressions.RegexOptions.IgnoreCase | System.Text.RegularExpressions.RegexOptions.Singleline);
        
        // Remove style tags and their content
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, 
            @"<style[^>]*>.*?</style>", "", 
            System.Text.RegularExpressions.RegexOptions.IgnoreCase | System.Text.RegularExpressions.RegexOptions.Singleline);
        
        // Remove event handlers (onclick, onerror, etc.)
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, 
            @"\s*on\w+\s*=\s*[""'][^""']*[""']", "", 
            System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove javascript: protocol from links
        sanitized = System.Text.RegularExpressions.Regex.Replace(sanitized, 
            @"href\s*=\s*[""']javascript:[^""']*[""']", "href=\"#\"", 
            System.Text.RegularExpressions.RegexOptions.IgnoreCase);

        return new MarkupString(sanitized);
    }
}
