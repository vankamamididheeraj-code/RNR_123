@page "/yearquarter/create"
@layout EmptyLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@using System.Net.Http.Json
@using RewardsAndRecognitionBlazorApp.ViewModels
@using RewardsAndRecognitionBlazorApp.Helpers
@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>Create Year Quarter</PageTitle>

<style>
    .btn-indigo {
        background: #303f9f;
        color: white;
    }

        .btn-indigo:hover {
            background: #303f9f;
            color: white;
        }

    .btn-danger {
        background: #c62828;
        color: white;
    }

        .btn-danger:hover {
            background: #b71c1c;
            color: white;
        }
</style>

<h2 class="mb-4">Create Year Quarter</h2>

<div class="card p-4 shadow-sm" style="max-width: 600px; margin: auto;">
    <EditForm Model="@model" OnValidSubmit="CreateAsync">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger mb-3" />

        <div class="mb-3">
            <label class="form-label">Year</label><span class="text-danger">*</span>
            <InputNumber class="form-control" @bind-Value="model.Year" @bind-Value:after="UpdateDateRange" />
            <ValidationMessage For="@(() => model.Year)" class="text-danger" />
        </div>

        <div class="mb-3">
            <label class="form-label">Quarter</label><span class="text-danger">*</span>
            <InputSelect class="form-select" @bind-Value="model.Quarter" @bind-Value:after="UpdateDateRange">
                <option value="">-- Select Quarter --</option>
                @foreach (var q in quarters)
                {
                    <option value="@q">@q</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => model.Quarter)" class="text-danger" />
        </div>

        <div class="mb-3">
            <label class="form-label">Start Date</label><span class="text-danger">*</span>
            <input type="text" class="form-control" value="@(model.StartDate?.ToString("yyyy-MM-dd"))" readonly disabled />
            <small class="text-muted">Auto-calculated from Year and Quarter</small>
        </div>

        <div class="mb-3">
            <label class="form-label">End Date</label><span class="text-danger">*</span>
            <input type="text" class="form-control" value="@(model.EndDate?.ToString("yyyy-MM-dd"))" readonly disabled />
            <small class="text-muted">Auto-calculated from Year and Quarter</small>
        </div>

        <div class="form-check mb-3">
            <InputCheckbox class="form-check-input" @bind-Value="model.IsActive" id="isActiveChk" />
            <label class="form-check-label" for="isActiveChk">Is Active</label>
        </div>

        @if (!string.IsNullOrWhiteSpace(error))
        {
            <div class="text-danger mb-3">@error</div>
        }

        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-danger" @onclick="Cancel">Cancel</button>

            <button type="submit" class="btn btn-indigo" disabled="@isSubmitting">
                @(isSubmitting ? "Creating..." : "Create")
            </button>
        </div>
    </EditForm>
</div>

@code {
    private YearQuarterView model = new();
    private bool isSubmitting;
    private string? error;

    // dropdown values (same idea as ViewBag.Quarters)
    private readonly List<Quarter> quarters = Enum.GetValues<Quarter>().ToList();

    private void UpdateDateRange()
    {
        // Auto-calculate dates when Year or Quarter changes
        if (model.Year > 0 && model.Quarter.HasValue)
        {
            try
            {
                var (startDate, endDate) = QuarterDateHelper.GetQuarterDateRange(model.Year, model.Quarter.Value);
                model.StartDate = startDate;
                model.EndDate = endDate;
            }
            catch
            {
                // Invalid year or quarter
                model.StartDate = null;
                model.EndDate = null;
            }
        }
        else
        {
            model.StartDate = null;
            model.EndDate = null;
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/yearquarter");
    }

    private async Task CreateAsync()
    {
        try
        {
            error = null;
            isSubmitting = true;

            // Validate that Quarter and Year are provided
            if (!model.Quarter.HasValue || model.Year <= 0)
            {
                error = "Year and Quarter are required.";
                return;
            }

            // Ensure a new id (API may also generate, but your model has Id)
            if (model.Id == Guid.Empty)
                model.Id = Guid.NewGuid();

            // Post to your WebAPI controller
            var resp = await Http.PostAsJsonAsync("api/yearquarter", model);

            if (!resp.IsSuccessStatusCode)
            {
                // you can read more details if your API returns them
                var body = await resp.Content.ReadAsStringAsync();
                error = string.IsNullOrWhiteSpace(body)
                    ? $"Create failed ({(int)resp.StatusCode})."
                    : $"Create failed ({(int)resp.StatusCode}): {body}";
                return;
            }

            Nav.NavigateTo("/yearquarter");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
