@page "/dashboard/teamlead"
@layout EmptyLayout
@inject HttpClient Http
@inject RewardsAndRecognitionBlazorApp.ViewModels.UserSession Session
@inject NavigationManager Nav
@inject IJSRuntime JS
 
<PageTitle>Team Lead Dashboard</PageTitle>
 
@if (!IsInitialized)
{
    <p>Loading...</p>
}
else if (!Session.IsLoggedIn || !IsTeamLeadRole())
{
    <p>Access denied. Please log in as Team Lead. (Current role: @Session.Role)</p>
}
else
{
<TeamLeadNavBar ActivePage="Dashboard" />
 
    <h2 class="mb-4"><i class="bi bi-award"></i> Team Lead Dashboard</h2>
 
    <div class="row mb-4">
        <div class="col-md-3">
            <label for="yearDropdown" class="form-label">Select Year:</label>
            <select @onchange="OnYearChangedAsync" value="@SelectedYear" class="form-select">
                <option value="">-- Select Year --</option>
                @foreach (var year in Years)
                {
                    <option value="@year">@year</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label for="quarterDropdown" class="form-label">Select Quarter:</label>
            <select @onchange="OnQuarterChangedAsync" value="@SelectedQuarterId" disabled="@(string.IsNullOrEmpty(SelectedYear))" class="form-select">
                <option value="">-- Select Quarter --</option>
                @foreach (var quarter in Quarters)
                {
                    <option value="@quarter.Id">@quarter.Name</option>
                }
            </select>
        </div>
    </div>
 
    <style>
        .quarter-card {
            background-color: #f1f5ff;
            color: #002c75;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            width: 12rem;
            text-align: left;
            border-left: 4px solid #0d6efd;
            transition: all 0.3s ease-in-out;
        }
 
        .quarter-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
 
        .dashboard-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            transition: transform 0.2s ease;
            height: 100%;
            text-decoration: none;
        }
 
        .dashboard-card:hover {
            transform: translateY(-3px);
            text-decoration: none;
        }
 
        .dashboard-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 10px;
            color: #555;
        }
 
        .dashboard-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-top: 5px;
            color: #222;
        }
 
        .clickable-card {
            text-decoration: none;
        }
    </style>
 
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <a href="javascript:void(0);" @onclick='() => NavigateToNominations("all")' class="clickable-card">
                <div class="dashboard-card">
                    <div class="dashboard-title">Total Nominations</div>
                    <div class="dashboard-value text-blue">@TotalNominations</div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="javascript:void(0);" @onclick='() => NavigateToNominations("pending")' class="clickable-card">
                <div class="dashboard-card">
                    <div class="dashboard-title">Pending Reviews</div>
                    <div class="dashboard-value text-orange">@PendingNominations</div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="javascript:void(0);" @onclick='() => NavigateToNominations("directorapproved")' class="clickable-card">
                <div class="dashboard-card">
                    <div class="dashboard-title">Final Approved</div>
                    <div class="dashboard-value text-green">@FinalApprovedNominations</div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="javascript:void(0);" @onclick='() => NavigateToNominations("directorrejected")' class="clickable-card">
                <div class="dashboard-card">
                    <div class="dashboard-title">Final Rejected</div>
                    <div class="dashboard-value text-danger">@RejectedNominations</div>
                </div>
            </a>
        </div>
    </div>
 
    <h4 class="mt-5 mb-3 text-primary">Category-wise Breakdown</h4>
    <div id="teamLeadChartsContainer" class="row row-cols-1 row-cols-md-2 g-4 mb-5">
        <div class="col">
            <div class="dashboard-card text-center p-4">
                <h5 class="text-muted mb-2">ðŸ“Š Analytics Coming Soon</h5>
                <p class="mb-0">Category-wise breakdown will be available once the analytics controller is implemented.</p>
            </div>
        </div>
    </div>
}
 
@code {
    private List<int> Years = new();
    private List<QuarterView> Quarters = new();
    private string SelectedYear = "";
    private string SelectedQuarterId = "";
    private int TotalNominations;
    private int PendingNominations;
    private int FinalApprovedNominations;
    private int RejectedNominations;
    private string ActiveQuarterId = "";
    private bool IsInitialized = false;
 
    protected override async Task OnInitializedAsync()
    {
        await Session.InitializeAsync(JS, forceRefresh: true);
        IsInitialized = true;
        await LoadYears();
        // Set default to current year/quarter if available
        // Assuming we have a way to get current
        await LoadDashboardData();
    }
 
    private async Task LoadYears()
    {
        try
        {
            Years = await Http.GetFromJsonAsync<List<int>>("api/yearquarter/years") ?? new List<int>();
        }
        catch (Exception)
        {
            // Handle error
        }
    }
 
    private async Task OnYearChangedAsync(ChangeEventArgs e)
    {
        SelectedYear = e.Value?.ToString() ?? "";
        if (!string.IsNullOrEmpty(SelectedYear))
        {
            await LoadQuarters();
        }
        else
        {
            Quarters.Clear();
            SelectedQuarterId = "";
        }
        await LoadDashboardData();
    }
 
    private async Task LoadQuarters()
    {
        try
        {
            var result = await JS.InvokeAsync<System.Text.Json.JsonElement>(
                "fetchWithCredentials",
                "GET",
                $"api/yearquarter/quarters/{SelectedYear}",
                null
            );
            
            string response = result.GetProperty("text").GetString() ?? "[]";
            Quarters = System.Text.Json.JsonSerializer.Deserialize<List<QuarterView>>(
                response,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }
            ) ?? new List<QuarterView>();
        }
        catch (Exception)
        {
            // Handle error
            Quarters = new List<QuarterView>();
        }
    }
 
    private async Task OnQuarterChangedAsync(ChangeEventArgs e)
    {
        SelectedQuarterId = e.Value?.ToString() ?? "";
        await LoadDashboardData();
    }
 
    private async Task LoadDashboardData()
    {
        if (string.IsNullOrEmpty(SelectedQuarterId)) return;
 
        try
        {
            var result = await JS.InvokeAsync<System.Text.Json.JsonElement>(
                "fetchWithCredentials",
                "GET",
                $"api/Dashboard/TeamLead?yearQuarterId={SelectedQuarterId}",
                null
            );
            
            string response = result.GetProperty("text").GetString() ?? "";
            var data = System.Text.Json.JsonSerializer.Deserialize<TeamLeadDashboardView>(
                response,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }
            );
            
            if (data != null)
            {
                TotalNominations = data.TotalNominations;
                PendingNominations = data.PendingNominations;
                FinalApprovedNominations = data.FinalApprovedNominations;
                RejectedNominations = data.RejectedNominations;
                ActiveQuarterId = SelectedQuarterId;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }
 
    private void NavigateToNominations(string filter)
    {
        if (string.IsNullOrEmpty(SelectedQuarterId))
        {
            // Alert or something
            return;
        }
        Nav.NavigateTo($"/nomination/index?filter={filter}&yearQuarterId={SelectedQuarterId}");
    }

    private bool IsTeamLeadRole()
    {
        if (string.IsNullOrWhiteSpace(Session.Role))
            return false;
        
        var role = Session.Role.Trim();
        return role.Equals("TeamLead", StringComparison.OrdinalIgnoreCase) || 
               role.Equals("Team Lead", StringComparison.OrdinalIgnoreCase);
    }

    public class QuarterView
    {
        public string? Id { get; set; }
        public string? Name { get; set; }
    }
 
    public class TeamLeadDashboardView
    {
        public int TotalNominations { get; set; }
        public int PendingNominations { get; set; }
        public int FinalApprovedNominations { get; set; }
        public int RejectedNominations { get; set; }
    }
}